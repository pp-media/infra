---
##
## Pre-tasks
##

- name: Global pre tasks
  hosts: lunix
  remote_user: root
  gather_facts: false
  pre_tasks:
  - name: Verify Ansible meets version requirements.
    assert:
      that: "ansible_version.full is version_compare('2.16', '>=')"
      msg: >
        "You must update Ansible to at least 2.16."

  - name: Install ansible dependencies (python)
    # install python3-apt to avoid needlesly triggering the next test
    raw: test -e /usr/bin/python3 || (apt-get -y update && apt-get install -y python3-minimal python3-apt)
    changed_when: false  # raw has no change handler

  - name: Install ansible dependencies (python3-apt)
    raw: test -e /usr/lib/python3/dist-packages/apt/package.py || (apt-get -y update && apt-get install -y python3-apt)
    changed_when: false  # raw has no change handler

  - name: "Get name of wired physical interface"
    shell: "find /sys/class/net -type l -not -lname '*virtual*' -printf '%f\n' | grep -e '^[^w]' | head -n 1"
    register: _phy_if_cmd
    check_mode: no

  - name: "Register wired interface as fact"
    ansible.builtin.set_fact:
      phy_if: "{{ _phy_if_cmd.stdout }}"

###
### Common roles
###

# # Workaround for https://github.com/ansible/ansible/issues/57529
# - hosts: all

- name: Common roles
  hosts: lunix
  remote_user: root
  tags: [common]
  roles:
  - common

- name: k3s
  hosts: k3s
  remote_user: root
  tags: [k3s]
  roles:
    - k3s

- name: "Caspar CG"
  hosts: casparcg
  remote_user: root
  tags: [ccg]
  roles:
    - "casparcg-server"
